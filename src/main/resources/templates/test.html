<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/vnd.icon" href="/images/apeaj.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/css/accueil.css" rel="stylesheet" />
    <script src="/js/jquery-3.2.1.slim.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <title>Chat</title>
    <style>
        body {
            background: #eee;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .chat-list {
            padding: 0;
            font-size: .8rem;
            height: 60vh;
            /* Set the height of the chat to 60% of viewport height */
            overflow-y: auto;
            /* Enable vertical scrollbar */
        }

        .chat-list li {
            margin-bottom: 10px;
            overflow: auto;
            color: #ffffff;
        }

        .chat-list .chat-img {
            float: left;
            width: 48px;
        }

        .chat-list .chat-img img {
            -webkit-border-radius: 50px;
            -moz-border-radius: 50px;
            border-radius: 50px;
            width: 100%;
        }

        .chat-list .chat-message {
            border-radius: 10px;
            background: #a2a2a2;
            display: inline-block;
            padding: 1vh 1vw;
            position: relative;
        }

        .chat-list .chat-message:before {
            content: "";
            position: absolute;
            top: 15px;
            width: 0;
            height: 0;
        }

        .chat-list .chat-message h5 {
            margin: 0 0 5px 0;
            font-weight: 600;
            line-height: 100%;
            font-size: .9rem;
        }

        .chat-list .chat-message p {
            margin: 0;
            padding: 0;
            text-align: initial;
        }

        .chat-list .chat-body {
            margin-left: 20px;
            float: left;
            width: 70%;
        }

        .chat-list .in .chat-message:before {
            left: -15px;
            border-bottom: 15px solid transparent;
            border-right: 15px solid #a2a2a2;
        }

        .chat-list .out .chat-img {
            float: right;
        }

        .chat-list .out .chat-body {
            float: right;
            margin-right: 20px;
            text-align: right;
        }

        .chat-list .out .chat-message {
            background: #5a99ee;
        }

        .chat-list .out .chat-message:before {
            right: -15px;
            border-bottom: 15px solid transparent;
            border-left: 15px solid #5a99ee;
        }

        .card .card-header:first-child {
            -webkit-border-radius: 0.3rem 0.3rem 0 0;
            -moz-border-radius: 0.3rem 0.3rem 0 0;
            border-radius: 0.3rem 0.3rem 0 0;
        }

        .card .card-header {
            background: #bbdefb;
            border: 0;
            font-size: 1rem;
            padding: .65rem 1rem;
            position: relative;
            font-weight: 600;
            color: #000000;
        }

        .content {
            margin-top: 40px;
        }
    </style>
</head>

<body>
    <div th:replace="fragments/header :: header"></div>
    <div class="container content">
        <div class="row">
            <div class="">
                <div class="card">
                    <div class="card-header">Messages</div>
                    <div class="height3">
                        <ul class="chat-list">
                            <div th:each="message, iterStat : ${messages}">
                                <span
                                    th:if="${iterStat.index > 0 and !#temporals.format(messages[iterStat.index].timestamp, 'dd/MM/yy').equals(#temporals.format(messages[iterStat.index - 1].timestamp, 'dd/MM/yy'))}"
                                    style="color: #17202b; text-align: center; display: block;"
                                    th:text="${#temporals.format(message.timestamp, 'dd/MM/yy')}"
                                    class="message-timestamp"></span>
                                <span th:if="${iterStat.index == 0}"
                                    style="color: #17202b; text-align: center; display: block;"
                                    th:text="${#temporals.format(message.timestamp, 'dd/MM/yy')}"
                                    class="message-timestamp"></span>

                                <li th:class="${message.sender.login == currentUserName} ? 'out' : 'in'">
                                    <div class="chat-img">
                                        <img alt="photo" th:src="${message.sender.photoBase64}">
                                    </div>
                                    <div class="chat-body">
                                        <div class="chat-message">
                                            <h5 th:text="${message.sender.nom} + ' ' + ${message.sender.prenom}"></h5>
                                            <button class="btn play-button apply-filter"
                                                th:if="${message.audio != null}" th:id="'playButton-' + ${message.id}">
                                                <img src="/images/son.png" alt="Play" class="user-image"
                                                    style="max-width: 50px; height: auto;" />
                                            </button>
                                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                                <p th:if="${message.textContent != null}" th:text="${message.textContent}">
                                                </p>
                                                <div style="color: #17202b;padding-left: 3vw;"
                                                    th:text="${#temporals.format(message.timestamp, 'HH:mm')}"
                                                    class="message-timestamp"></div>
                                            </div>
                                            
                                        
                                            <audio style="display: none;" class="w-100" controls
                                                th:if="${message.audio != null}" th:id="'audio-' + ${message.id}"
                                                th:src="'data:audio/ogg;base64,'+ ${message.getAudioBase64()}"></audio>
                                        </div>
                                    </div>
                                </li>
                            </div>

                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <form class="form" th:action="@{/send}" method="post" enctype="multipart/form-data" autocomplete="off"
            id="uploadForm">
            <div style="display: flex; justify-content: space-between; align-items: center;margin-top: 1vh;">
                <input type="text" id="textContent" name="textContent" placeholder="Type a message" class="form-control" style="flex-grow: 1; margin-right: 10px;">
                <input type="submit" value="Send" class="btn btn-primary">
            </div>
            <input style="display: none;" type="file" name="voiceContent" accept="audio/*" id="voiceContent" class="form-control">

            <div class="mb-4">
                <button id="startRecording" class="btn btn-success button" type="button">
                    Commencer l'enregistrement
                </button>
                <button id="stopRecording" class="btn btn-danger button" disabled type="button">
                    Arreter l'enregistrement
                </button>
                <span id="timer">00:00</span>
                <audio class="w-100" id="audioPlayer" controls style="display: none"></audio>
            </div>

        </form>
    </div>
</body>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const playButtons = document.querySelectorAll('.play-button.apply-filter');

        playButtons.forEach(button => {
            const img = button.querySelector('img');
            button.addEventListener('click', () => {
                const audioId = 'audio-' + button.id.split('-')[1];
                const audio = document.getElementById(audioId);

                if (audio.paused) {
                    audio.play();
                    img.src = '/images/son.png'; // Image pour l'état de pause
                    //mettre l'arriere plan en blanc
                    img.style.backgroundColor = '#ffffff';
                } else {
                    audio.pause();
                    img.src = '/images/son.png'; // Image pour l'état de lecture
                    //mettre l'arriere plan en bleu
                    img.style.backgroundColor = '#5a99ee';
                }
            });

            const audioId = 'audio-' + button.id.split('-')[1];
            const audio = document.getElementById(audioId);

            audio.addEventListener('ended', () => {
                img.src = '/images/son.png'; // Image pour l'état de lecture
                //mettre l'arriere plan en bleu
                img.style.backgroundColor = '#5a99ee';
            });
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const startRecordingButton = document.getElementById("startRecording");
        const stopRecordingButton = document.getElementById("stopRecording");
        const audioPlayer = document.getElementById("audioPlayer");
        const timerElement = document.getElementById("timer");
        let mediaRecorder;
        let audioBlob;
        let chunks = [];
        let timerInterval;
        let secondsElapsed = 0;

        // Fonction pour mettre � jour le minuteur
        function updateTimer() {
            secondsElapsed++;
            let minutes = Math.floor(secondsElapsed / 60);
            let seconds = secondsElapsed % 60;
            timerElement.textContent = `${minutes
                .toString()
                .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }

        // R�initialiser le minuteur
        function resetTimer() {
            clearInterval(timerInterval);
            secondsElapsed = 0;
            timerElement.textContent = "00:00";
        }

        startRecordingButton.addEventListener("click", () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices
                    .getUserMedia({ audio: true })
                    .then((stream) => {
                        mediaRecorder = new MediaRecorder(stream);

                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) chunks.push(event.data);
                        };

                        mediaRecorder.onstop = () => {
                            audioBlob = new Blob(chunks, { type: "audio/mp3" });
                            chunks = [];

                            const audioURL = URL.createObjectURL(audioBlob);
                            audioPlayer.src = audioURL;
                            audioPlayer.style.display = "block";

                            startRecordingButton.disabled = false;
                            stopRecordingButton.disabled = true;
                        };

                        mediaRecorder.start();
                        startRecordingButton.disabled = true;
                        stopRecordingButton.disabled = false;
                        timerInterval = setInterval(updateTimer, 1000);
                    })
                    .catch((error) => {
                        console.error("Erreur lors de l'acc�s au microphone:", error);
                    });
            } else {
                console.error(
                    "L'API MediaRecorder n'est pas prise en charge dans ce navigateur."
                );
            }
        });

        stopRecordingButton.addEventListener("click", () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                resetTimer();
            }
        });

        // Gestionnaire d'�v�nements pour la soumission du formulaire
        document
            .getElementById("uploadForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const textContent = document.getElementById('textContent').value;
                if (textContent) {
                    formData.append('message', textContent);
                }

                if (audioBlob) {
                    formData.append("audioFile", audioBlob, "enregistrement.mp3");
                }

                fetch("/send", {
                    method: "POST",
                    body: formData,
                })
                    .then((response) => {
                        location.reload(); // Rafra�chir la page
                    })
                    .catch((error) => {
                        location.reload(); // Rafra�chir la page
                    });
            });

        const chatList = document.querySelector('.chat-list');
        chatList.scrollTop = chatList.scrollHeight;
    });
</script>

</html>