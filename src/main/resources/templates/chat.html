<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/vnd.icon" href="/images/apeaj.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Ajoutez les liens vers les fichiers CSS Bootstrap ici -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/css/accueil.css" rel="stylesheet" />
    <!-- Ajoutez les liens vers les fichiers JavaScript Bootstrap et jQuery ici -->
    <script src="/js/jquery-3.2.1.slim.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <title>Chat</title>
    <style>
        .form {
            max-width: 60vw;
            margin: auto;
        }

        .message-container {
            max-width: 60vw;
            /* Ajustez la largeur maximale selon vos besoins */
            margin: auto;
            height: 70vh;
            /* Ajustez la hauteur selon vos besoins */
            overflow-y: auto;
            /* Ajoutez le défilement vertical */
            display: flex;
            flex-direction: column;
            /* Inversez l'ordre des éléments pour afficher les derniers messages en bas */
        }

        .message {
            margin-bottom: 10px;
            border-radius: 10px;
            padding-left: 10px;
            padding-right: 10px;
            max-width: 70%;
            width: fit-content;
            position: relative;
        }

        .sender {
            background-color: #bbdefb;
            /* Couleur pour l'exp�diteur */
            color: #000000;
            /* Couleur du texte pour l'exp�diteur */
            align-self: flex-end;
            margin-left: auto;
            /* Aligner � droite */
        }

        .receiver {
            background-color: #f8f9fa;
            /* Couleur pour le destinataire */
            color: #000000;
            /* Couleur du texte pour le destinataire */
            align-self: flex-start;
            margin-right: auto;
            /* Aligner � gauche */
        }

        .sender-name {
            text-align: right;
            margin: 0;
        }

        .sender-info {
            text-align: center;
        }

        .receiver-name {
            text-align: left;
            margin: 0;
        }

        .message-timestamp {
            text-align: right;
            margin-top: auto;
            color: #495057;
        }

        p {
            margin: 0;
        }

        .image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 10px;
        }

        .message-content {
            display: flex;
            align-items: center;
        }

        .user-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 10px;
        }

        .align-left {
            float: left;
        }

        .align-right {
            float: right;
        }
    </style>

</head>

<body>

    <div th:replace="fragments/header :: header"></div>
    <div class="message-container">
        <div th:each="message : ${messages}">
            <div class="sender-info">
                <p th:text="${message.sender.nom} + ' ' + ${message.sender.prenom}"
                    th:class="${message.sender.login == currentUserName} ? 'sender-name' : 'receiver-name'"></p>
            </div>
            <div class="message-content">
                <img th:if="${message.sender.login != currentUserName}" th:src="${message.sender.photoBase64}"
                    alt="User Image"
                    th:class="${message.sender.login == currentUserName} ? 'user-image align-right' : 'user-image align-left'" />


                <div class="message d-flex flex-column"
                    th:class="${message.sender.login == currentUserName} ? 'message sender' : 'message receiver'">

                    <p th:text="${message.textContent}"></p>

                    <button class="btn play-button apply-filter" th:if="${message.audio != null}"
                        th:id="'playButton-' + ${message.id}">
                        <img src="/images/son.png" alt="Play" class="user-image"
                            style="max-width: 50px; height: auto;" />
                    </button>

                    <audio style="display: none;" class="w-100" controls th:if="${message.audio != null}"
                        th:id="'audio-' + ${message.id}"
                        th:src="'data:audio/ogg;base64,' + ${message.getAudioBase64()}"></audio>
                    
                    </p>
                </div>
                <img th:if="${message.sender.login == currentUserName}" th:src="${message.sender.photoBase64}"
                    alt="User Image"
                    th:class="${message.sender.login == currentUserName} ? 'user-image align-right' : 'user-image align-left'" />
                    <p th:text="${#temporals.format(message.timestamp, 'dd/MM/yy HH:mm')}" class="message-timestamp">
                </div>

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const playButtons = document.querySelectorAll('.play-button.apply-filter');

                    playButtons.forEach(button => {
                        const img = button.querySelector('img');
                        button.addEventListener('click', () => {
                            const audioId = 'audio-' + button.id.split('-')[1];
                            const audio = document.getElementById(audioId);

                            if (audio.paused) {
                                audio.play();
                                img.src = '/images/son.png'; // Image pour l'état de pause
                            } else {
                                audio.pause();
                                img.src = '/images/son.png'; // Image pour l'état de lecture
                            }
                        });

                        const audioId = 'audio-' + button.id.split('-')[1];
                        const audio = document.getElementById(audioId);

                        audio.addEventListener('ended', () => {
                            img.src = '/images/son.png'; // Image pour l'état de lecture
                        });
                    });
                });
            </script>

        </div>
</div>
        <form class="form" th:action="@{/send}" method="post" enctype="multipart/form-data" autocomplete="off" id="uploadForm">
            <input type="text" id="textContent" name="textContent" placeholder="Type a message" class="form-control">
            <input type="file" name="voiceContent" accept="audio/*" id="voiceContent" class="form-control">

            <div class="mb-4">
                <button id="startRecording" class="btn btn-success button" type="button">
                    Commencer l'enregistrement
                </button>
                <button id="stopRecording" class="btn btn-danger button" disabled type="button">
                    Arreter l'enregistrement
                </button>
                <span id="timer">00:00</span>
                <audio class="w-100" id="audioPlayer" controls style="display: none"></audio>
            </div>
            <input type="submit" value="Send" class="btn btn-primary mt-2">
        </form>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const startRecordingButton = document.getElementById("startRecording");
            const stopRecordingButton = document.getElementById("stopRecording");
            const audioPlayer = document.getElementById("audioPlayer");
            const timerElement = document.getElementById("timer");
            let mediaRecorder;
            let audioBlob;
            let chunks = [];
            let timerInterval;
            let secondsElapsed = 0;

            // Fonction pour mettre � jour le minuteur
            function updateTimer() {
                secondsElapsed++;
                let minutes = Math.floor(secondsElapsed / 60);
                let seconds = secondsElapsed % 60;
                timerElement.textContent = `${minutes
                    .toString()
                    .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
            }

            // R�initialiser le minuteur
            function resetTimer() {
                clearInterval(timerInterval);
                secondsElapsed = 0;
                timerElement.textContent = "00:00";
            }

            startRecordingButton.addEventListener("click", () => {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices
                        .getUserMedia({ audio: true })
                        .then((stream) => {
                            mediaRecorder = new MediaRecorder(stream);

                            mediaRecorder.ondataavailable = (event) => {
                                if (event.data.size > 0) chunks.push(event.data);
                            };

                            mediaRecorder.onstop = () => {
                                audioBlob = new Blob(chunks, { type: "audio/mp3" });
                                chunks = [];

                                const audioURL = URL.createObjectURL(audioBlob);
                                audioPlayer.src = audioURL;
                                audioPlayer.style.display = "block";

                                startRecordingButton.disabled = false;
                                stopRecordingButton.disabled = true;
                            };

                            mediaRecorder.start();
                            startRecordingButton.disabled = true;
                            stopRecordingButton.disabled = false;
                            timerInterval = setInterval(updateTimer, 1000);
                        })
                        .catch((error) => {
                            console.error("Erreur lors de l'acc�s au microphone:", error);
                        });
                } else {
                    console.error(
                        "L'API MediaRecorder n'est pas prise en charge dans ce navigateur."
                    );
                }
            });

            stopRecordingButton.addEventListener("click", () => {
                if (mediaRecorder) {
                    mediaRecorder.stop();
                    resetTimer();
                }
            });

            // Gestionnaire d'�v�nements pour la soumission du formulaire
            document
                .getElementById("uploadForm")
                .addEventListener("submit", function (e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const textContent = document.getElementById('textContent').value;
                    if (textContent) {
                        formData.append('message', textContent);
                    }

                    if (audioBlob) {
                        formData.append("audioFile", audioBlob, "enregistrement.mp3");
                    }

                    fetch("/send", {
                        method: "POST",
                        body: formData,
                    })
                        .then((response) => {
                            location.reload(); // Rafra�chir la page
                        })
                        .catch((error) => {
                            location.reload(); // Rafra�chir la page
                        });
                });
        });
    </script>

</body>

</html>