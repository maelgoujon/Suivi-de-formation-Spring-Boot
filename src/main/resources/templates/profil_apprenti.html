<!DOCTYPE html>
<div lang="fr" xmlns:th="http://www.thymeleaf.org">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/vnd.icon" href="/images/cercle.ico">

        <!-- Ajoutez les liens vers les fichiers CSS Bootstrap ici -->
        <link href="/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/css/accueil.css" rel="stylesheet" />
        <!-- Ajoutez les liens vers les fichiers JavaScript Bootstrap et jQuery ici -->
        <script src="/js/jquery-3.2.1.slim.min.js"></script>
        <script src="/js/popper.min.js"></script>
        <script src="/js/bootstrap.bundle.min.js"></script>
        <style>
            .small-btn {
                padding: 0.2rem 0.5rem;
                font-size: 0.8rem;
            }

            .small-img {
                max-width: 40px;
                max-height: 40px;
            }
        </style>

        <title>Profil apprenti</title>

    </head>

    <body>
        <div>
            <div th:replace="fragments/header :: header"></div>

            <!-- Modal de Confirmation -->
            <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="modalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel">Confirmer la Suppression</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <strong>Êtes-vous sûr de vouloir supprimer cet utilisateur?</strong>
                            <br>
                            <small>Si vous souhaitez télécharger l'archive avant de supprimer, veuillez cliquer sur le
                                bouton ci-dessous.</small>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Non</button>
                            <button type="button" class="btn btn-danger"
                                onclick="document.getElementById('deleteUserForm').submit();">Oui</button>
                            <a th:href="@{/utilisateur/excel/{userId}(userId=${utilisateur.id})}"
                                class="btn btn-secondary">
                                <img src="/images/download.png" alt="Télécharger" style="width: 20px; height: 20px;" />
                                Télécharger
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="encadre p-4 bg-light">
                <div class="container mt-5">
                    <h2>Profil de : <span th:text="${utilisateur.nom}"></span> <span
                            th:text="${utilisateur.prenom}"></span></h2>
                    <div class="card mt-3">
                        <div class="card-body">
                            <p class="card-text"><strong>Login: </strong> <span th:text="${utilisateur.login}"></span>
                            </p>
                            <p class="card-text"><strong>Photo: </strong></p>
                            <img th:src="${utilisateur.photoBase64}" alt="Photo de l'utilisateur"
                                class="img-fluid rounded" style="max-width: 200px; max-height: 200px;">
                            <p th:if="${utilisateur.description != null and not #strings.isEmpty(utilisateur.description)}"
                                class="mt-3">
                                <strong>Description: </strong><span th:text="${utilisateur.description}"></span>
                            </p>

                            <div class="text-center">
                                <!-- S'affiche que si on est en superadmin -->
                                <div class="d-flex justify-content-center flex-wrap">
                                    <a th:if="${utilisateurConnecteRole == 'ROLE_SUPERADMIN'}"
                                        th:href="@{'/modif/' + ${utilisateur.id}}"
                                        class="btn btn-primary small-btn me-2 mb-2">
                                        <img src="/images/modif.png" alt="Modifier un apprenti"
                                            class="modifimg me-2 small-img" />
                                        Modifier profil
                                    </a>
                                    <!-- S'affiche que si on est en superadmin -->
                                    <a th:if="${utilisateurConnecteRole == 'ROLE_SUPERADMIN' and !utilisateur.archive}"
                                        th:data-download-url="@{/utilisateur/excel/{userId}(userId=${utilisateur.id})}"
                                        href="javascript:void(0);"
                                        onclick="downloadAndRedirect(this.getAttribute('data-download-url'), 'https://localhost:8081/accueil_superadmin')"
                                        class="btn btn-danger small-btn me-2 mb-2">
                                        <img src="/images/archive.png" alt="Archiver un apprenti"
                                            class="archiveimg me-2 small-img" />
                                        Archiver le profil
                                    </a>

                                    <form th:action="@{/utilisateur/desarchiver/{userId}(userId=${utilisateur.id})}"
                                        method="post"
                                        th:if="${utilisateurConnecteRole == 'ROLE_SUPERADMIN' and utilisateur.archive}">
                                        <button type="submit" class="btn btn-success small-btn me-2 mb-2">
                                            <img src="/images/archive.png" alt="Désarchiver un apprenti"
                                                class="archiveimg me-2 small-img" />
                                            Désarchiver le profil
                                        </button>
                                    </form>

                                    <form th:if="${utilisateurConnecteRole == 'ROLE_SUPERADMIN'}"
                                        th:action="@{/utilisateur/supprimer/{userId}(userId=${utilisateur.id})}"
                                        method="post" id="deleteUserForm">
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                                        <button type="button" class="btn btn-secondary small-btn me-2 mb-2"
                                            data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                                            <img src="/images/bin.png" alt="Supprimer un utilisateur"
                                                class="archiveimg small-img" />
                                        </button>
                                    </form>




                                    <!-- S'affiche que si on est en admin -->
                                    <a th:if="${utilisateurConnecteRole == 'ROLE_ADMIN'}"
                                        th:href="@{/ajoutfiche/{id}(id=${utilisateur.id})}"
                                        class="btn btn-outline-primary small-btn me-2 mb-2">
                                        <img src="/images/plus.png" alt="Ajouter une fiche"
                                            class="modifimg me-2 small-img" />
                                        Ajouter une fiche
                                    </a>

                                    <a th:if="${utilisateurConnecteRole == 'ROLE_ADMIN' or utilisateurConnecteRole == 'ROLE_CIP' or utilisateurConnecteRole == 'ROLE_EDUCSIMPLE'}"
                                        th:href="@{'/fiche/liste_fiche_id/' + ${utilisateur.id}}"
                                        class="btn btn-outline-primary small-btn me-2 mb-2">
                                        <img src="/images/yeux.png" alt="Voir fiche" class="modifimg me-2 small-img" />
                                        Voir ses fiches
                                    </a>
                                    <!-- S'affiche que si on est en cip -->
                                    <a th:if="${utilisateurConnecteRole == 'ROLE_CIP'}"
                                        th:href="@{'/suivi_progression/' + ${utilisateur.id}}"
                                        class="btn btn-outline-primary small-btn me-2 mb-2">
                                        <img src="/images/yeux.png" alt="Suivi parcours"
                                            class="modifimg me-2 small-img" />
                                        Suivi parcours
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </body>
    <script>
        function downloadAndRedirect(downloadUrl, redirectUrl) {
            // Initie le téléchargement en changeant l'URL de la fenêtre
            window.location.href = downloadUrl;
            // Redirige vers une nouvelle page après un court délai pour permettre le début du téléchargement
            setTimeout(function () {
                window.location.href = redirectUrl;
            }, 1500); // Le délai de 1500ms (1,5 secondes) 
        }
    </script>


    </html>